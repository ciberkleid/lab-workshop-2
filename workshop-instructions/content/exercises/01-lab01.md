# Intro to the Color Application

## App overview
For the following exercises, you will be using an application that displays colors to the end user. 
Each time the end user refreshes the page in a browser, a different color is displayed.

The application comprises the following Spring Boot apps:
- Auth Gateway App - Intercepts all requests and ensures the user is authenticated; if the user is not authenticated, it redirects the request to a login page.
- Routing Gateway App - Intercepts all authenticated requests and forwards them to the proper Spring Boot app; requests generated by end users are forwarded to the frontend app, while requests generated by the frontend app are forwarded to a backend app.
- Frontend App - Produces the HTML and JavaScript that will be served to the end user.
- Backend App - Returns a particular color; four instances of this app will be started: blue, green, "slow" green with a 5 second delay, and yellow.

## Download the source code

Start by cloning the application:
```execute-1
git clone https://github.com/springone-tour-2021/gateway-s1p-2018.git color-app
```

Change into the cloned directory in both terminal windows.
We can also set the `PS1` env var to make the prompt easier to read.
```execute-all
oldps1="$PS1" && export PS1="\e[;33m[\w]\$ \e[m "
cd color-app
```

List the directories in the repository.
```execute-1
ls
```

Your output will show several apps, a script, and a service broker. 
```
$ ls
authgateway  blueorgreenfrontend  blueorgreengateway  blueorgreenservice  deploy.sh  route-service-broker
```

You can ignore the script and the service broker as we will not be using them in this workshop. 
Otherwise, notice the correlation between the cloned apps and the apps listed in the bullet points above (_hint:_ blueorgreengateway is the routing gateway and blueorgreenservice is the backend service).

The application uses Eureka for service discovery. 
This enables you to expose only the Auth Gateway to the end user, and keep the other apps securely hidden behind it on an internal network. 
The Auth Gateway uses Eureka to look up the endpoint of the Routing Gateway, and the Routing Gateway looks up the endpoints of the frontend app and of the four instances of the color app (blue, green, slowgreen, and yellow) to route requests appropriately.

The cloned repo does not include Eureka. 
Use `start.spring.io` to create a Eureka application:
```execute-1
curl https://start.spring.io/starter.tgz \
            -d dependencies=cloud-eureka-server \
            -d name=eureka \
            -d artifactId=eureka \
            -d baseDir=eureka | tar -xzvf -
```

You should now see a `eureka` directory in `color-apps` with the expected Spring Boot project structure.
```execute-1
tree eureka
```

Open the `eureka` application's main class.
```editor:select-matching-text
file: ~/color-app/eureka/src/main/java/com/example/eureka/EurekaApplication.java
text: "@SpringBootApplication"
```

Add the annotation `@EnableEurekaServer` to the main application class.
```editor:insert-lines-before-line
file: ~/color-app/eureka/src/main/java/com/example/eureka/EurekaApplication.java
line: 6
text: |
    import org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;

    @EnableEurekaServer
```

Open the `eureka` application's `application.properties` file. This file is initially empty.
```editor:open-file
file: ~/color-app/eureka/src/main/resources/application.properties
line: 1
```

Add properties to set the application port to 8761. 
By convention, this is the default port for Eureka servers. 
Also, this application only needs to act as a server - it does not need to register itself as a client as well. 
Hence, you can disable the built-in Eureka Client.
```editor:insert-lines-before-line
file: ~/color-app/eureka/src/main/resources/application.properties
line: 1
text: |
    server.port=8761
    eureka.client.register-with-eureka=false
    eureka.client.fetch-registry=false
```


### To verify your work 

At this point `~/color-app/eureka/src/main/java/com/example/eureka/EurekaApplication.java` should look like this.
```copy
package com.example.eureka;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

import org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;

@EnableEurekaServer
@SpringBootApplication
public class EurekaApplication {

	public static void main(String[] args) {
		SpringApplication.run(EurekaApplication.class, args);
	}

}
```

Your `~/color-app/eureka/src/main/resources/application.properties` is simply.
```copy
server.port=8761
eureka.client.register-with-eureka=false
eureka.client.fetch-registry=false
```